<!DOCTYPE html>
<html>

<head>
   
    <!-- <link href="style.css" rel="stylesheet" type="text/css"> -->
    <title>Map example</title>
    <style type="text/css">
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 70%;
      }
      }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
</head>

<body ng-app="map-example" ng-controller="MapController">

      <div class="container">
      <h2>Parameters</h2>
      <form>
        <div class="form-group row">
          <div class="col-xs-2">
            <label for="ex1">K</label>
            <input class="form-control" id="k" type="number" ng-model="k">
          </div>
          <div class="col-xs-2">
            <label for="ex3">Max %</label>
            <input class="form-control" id="max" type="number" step="0.01" ng-model="max">
          </div>
          <div class="col-xs-2">
              <label for="ex2">Min %</label>
              <input class="form-control" id="min" type="number" step="0.01" ng-model="min">
            </div>
          <div class="col-xs-2">
            <label for="ex3">Factor</label>
            <input class="form-control" id="factor" type="number" step="0.01" ng-model="factor">
          </div>
          <div class="col-xs-2">
            <button type="submit" class="btn btn-default" ng-click="getData(k, max, min, factor)" style="margin-top: 23px;">Run</button>
          </div>
        </div>
      </form>
      <center><p style="color: red" ng-show="showErr">{{errorMessage}}</p></center>
      <center><p style="color: red" ng-show="showKErr">{{kErrorMessage}}</p></center>
      <div id="legend">
        <h3>Legend</h3>
        <div ng-repeat="zone in colors_w_opac | limitTo:k; track by $index">
          <p style="float: left; margin-left: 10px" ng-style="getStyle(zone)">Zone:{{$index}}</p>
        </div>
      </div>
    </div>



    
    <div id="map"></div>
    
   

    <script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.1/lodash.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBs35QKJfPGL-1gPg5KgBKXdEI2xRKHrf4" async defer></script>
    <!-- <script src="script.js"></script> -->
    <script type="text/javascript">
      angular.module('map-example', [])
        .controller('MapController', function($scope, $rootScope, $compile, $http) {

            $scope.k = 4;
            $scope.max = 20;
            $scope.min = 1;
            $scope.factor = 1.5;
            $scope.showErr = false;
            $scope.showKErr = false;
            $scope.errorMessage = "Constraints Were Not Satisfied";
            $scope.kErrorMessage = "K should be an integer not decimal value";
            $scope.colors = ['red', 'green', 'yellow', 'blue', 'brown', 'cyan', 'pink', 'purple'];
            $scope.colors_w_opac = ['#d1a5a5', '#97c497', '#f0f097', '#9797f0', '#f0d197', '#97f0f0', '#f0dade', '#c497c4'];

            $scope.getStyle = function(color){
              return {
                'background-color': color,
              };
            };

            function formatMoney(n) {
              if(n > 100000){
                return n.toString().slice(0,3) + "," + n.toString().slice(3,6)
              }else{
                return n.toString().slice(0,2) + "," + n.toString().slice(2,5)
              }
            }

            $scope.showDetails = function (event) {
              var contentString = '<b>' + this.name + ' ($' + formatMoney(this.income) + ')</b><br><br>';
              for(var i = 0; i < this.routes.length; i++){

                var zone_from = Object.keys(this.routes[i])[0][1];
                var zone_to = Object.keys(this.routes[i])[0][3];
                var val = this.routes[i][Object.keys(this.routes[i])[0]];

                var temp = '<p>Zone ' + zone_from + ' - Zone ' + zone_to + ': $' + val + '<br>';
                contentString += temp;

              }
              $scope.infoWindow.setContent(contentString);
              $scope.infoWindow.setPosition(event.latLng);
              $scope.infoWindow.open($scope.map);
            };

            $scope.getData = function (k, max, min, factor) {

              if(k % 1 != 0){
                $scope.showKErr = true;
                return
              }

              $scope.showKErr = false;

              var url = "http://localhost:8080/result?zones=" + k + "&max=" + max + "&min=" + min + "&factor=" + factor; 

              $http.get(url)
                .then(function(response) {

                      var data = response.data;

                      console.log(response);

                      if(data.length == 0){
                        $scope.showErr = true;
                        return;
                      }

                      $scope.showErr = false;

                      initialize();

                      var nta_multipolygon = [];
                      
                      for(var i = 0; i < data.length; i++){

                        data[i]['polygon'] = [];

                        for(var j = 0; j < data[i]['geom']['coordinates'].length; j++){

                          for(var k = 0; k < data[i]['geom']['coordinates'][j].length; k++){


                            for(var x = 0; x < data[i]['geom']['coordinates'][j][k].length; x++){

                              data[i]['polygon'].push({
                                lat: data[i]['geom']['coordinates'][j][k][x][1],
                                lng: data[i]['geom']['coordinates'][j][k][x][0]
                              });

                            }

                          }

                        }

                      }

                      for(var a = 0; a < data.length; a++){

                        var neighborhood = new google.maps.Polygon({
                          paths: data[a]['polygon'],
                          strokeColor: 'gray',
                          strokeOpacity: 0.8,
                          strokeWeight: 2,
                          fillColor: $scope.colors[data[a]['zone']],
                          fillOpacity: 0.35,
                          name: data[a]['ntaname'],
                          routes: data[a]['routes'],
                          income: data[a]['income']
                        });
                        neighborhood.setMap($scope.map);
                        neighborhood.addListener('click', $scope.showDetails);

                      }

                      $scope.infoWindow = new google.maps.InfoWindow;

                      
                });

              
            };


            function initialize() {

                $scope.map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 11,
                    center: {lat: 40.755361, lng: -73.978515} 
                });
                
            }

            google.maps.event.addDomListener(window, 'load', initialize);

        });
    </script>
</body>

</html>